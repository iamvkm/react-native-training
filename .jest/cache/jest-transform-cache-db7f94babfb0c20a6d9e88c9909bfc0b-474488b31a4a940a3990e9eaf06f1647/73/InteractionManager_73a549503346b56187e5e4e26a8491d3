23d9f67ef97a8669d157d83592bd2f6f
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _EventEmitter = _interopRequireDefault(require("../vendor/emitter/EventEmitter"));
var BatchedBridge = require('../BatchedBridge/BatchedBridge');
var TaskQueue = require('./TaskQueue');
var infoLog = require('../Utilities/infoLog');
var invariant = require('invariant');
var _emitter = new _EventEmitter.default();
var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: {
    interactionStart: 'interactionStart',
    interactionComplete: 'interactionComplete'
  },
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();
      if (task) {
        tasks.push(task);
      }
      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });
      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('InteractionManager: create interaction handle');
    _scheduleUpdate();
    var handle = ++_inc;
    _addInteractionSet.add(handle);
    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('InteractionManager: clear interaction handle');
    invariant(!!handle, 'InteractionManager: Must provide a handle to clear.');
    _scheduleUpdate();
    _addInteractionSet.delete(handle);
    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};
var _interactionSet = new Set();
var _addInteractionSet = new Set();
var _deleteInteractionSet = new Set();
var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});
var _nextUpdateHandle = 0;
var _inc = 0;
var _deadline = -1;
function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}
function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;
  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });
  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });
  var nextInteractionCount = _interactionSet.size;
  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }
  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();
      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();
        break;
      }
    }
  }
  _addInteractionSet.clear();
  _deleteInteractionSet.clear();
}
module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfRXZlbnRFbWl0dGVyIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJCYXRjaGVkQnJpZGdlIiwiVGFza1F1ZXVlIiwiaW5mb0xvZyIsImludmFyaWFudCIsIl9lbWl0dGVyIiwiRXZlbnRFbWl0dGVyIiwiREVCVUdfREVMQVkiLCJERUJVRyIsIkludGVyYWN0aW9uTWFuYWdlciIsIkV2ZW50cyIsImludGVyYWN0aW9uU3RhcnQiLCJpbnRlcmFjdGlvbkNvbXBsZXRlIiwicnVuQWZ0ZXJJbnRlcmFjdGlvbnMiLCJ0YXNrIiwidGFza3MiLCJwcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJfc2NoZWR1bGVVcGRhdGUiLCJwdXNoIiwicnVuIiwibmFtZSIsIl90YXNrUXVldWUiLCJlbnF1ZXVlVGFza3MiLCJ0aGVuIiwiYmluZCIsImRvbmUiLCJhcHBseSIsImFyZ3VtZW50cyIsImNvbnNvbGUiLCJ3YXJuIiwiY2FuY2VsIiwiY2FuY2VsVGFza3MiLCJjcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSIsImhhbmRsZSIsIl9pbmMiLCJfYWRkSW50ZXJhY3Rpb25TZXQiLCJhZGQiLCJjbGVhckludGVyYWN0aW9uSGFuZGxlIiwiZGVsZXRlIiwiX2RlbGV0ZUludGVyYWN0aW9uU2V0IiwiYWRkTGlzdGVuZXIiLCJzZXREZWFkbGluZSIsImRlYWRsaW5lIiwiX2RlYWRsaW5lIiwiX2ludGVyYWN0aW9uU2V0IiwiU2V0Iiwib25Nb3JlVGFza3MiLCJfbmV4dFVwZGF0ZUhhbmRsZSIsInNldFRpbWVvdXQiLCJfcHJvY2Vzc1VwZGF0ZSIsInNldEltbWVkaWF0ZSIsImludGVyYWN0aW9uQ291bnQiLCJzaXplIiwiZm9yRWFjaCIsIm5leHRJbnRlcmFjdGlvbkNvdW50IiwiZW1pdCIsImhhc1Rhc2tzVG9Qcm9jZXNzIiwicHJvY2Vzc05leHQiLCJnZXRFdmVudExvb3BSdW5uaW5nVGltZSIsImNsZWFyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIkludGVyYWN0aW9uTWFuYWdlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZvcm1hdFxuICogQGZsb3cgc3RyaWN0LWxvY2FsXG4gKi9cblxuY29uc3QgQmF0Y2hlZEJyaWRnZSA9IHJlcXVpcmUoJy4uL0JhdGNoZWRCcmlkZ2UvQmF0Y2hlZEJyaWRnZScpO1xuY29uc3QgVGFza1F1ZXVlID0gcmVxdWlyZSgnLi9UYXNrUXVldWUnKTtcblxuY29uc3QgaW5mb0xvZyA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9pbmZvTG9nJyk7XG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdpbnZhcmlhbnQnKTtcblxuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICcuLi92ZW5kb3IvZW1pdHRlci9FdmVudEVtaXR0ZXInO1xuXG5leHBvcnQgdHlwZSBIYW5kbGUgPSBudW1iZXI7XG5pbXBvcnQgdHlwZSB7VGFza30gZnJvbSAnLi9UYXNrUXVldWUnO1xuXG5jb25zdCBfZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuICBpbnRlcmFjdGlvbkNvbXBsZXRlOiBbXSxcbiAgaW50ZXJhY3Rpb25TdGFydDogW10sXG59PigpO1xuXG5jb25zdCBERUJVR19ERUxBWTogMCA9IDA7XG5jb25zdCBERUJVRzogZmFsc2UgPSBmYWxzZTtcblxuLyoqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxsb3dzIGxvbmctcnVubmluZyB3b3JrIHRvIGJlIHNjaGVkdWxlZCBhZnRlciBhbnlcbiAqIGludGVyYWN0aW9ucy9hbmltYXRpb25zIGhhdmUgY29tcGxldGVkLiBJbiBwYXJ0aWN1bGFyLCB0aGlzIGFsbG93cyBKYXZhU2NyaXB0XG4gKiBhbmltYXRpb25zIHRvIHJ1biBzbW9vdGhseS5cbiAqXG4gKiBBcHBsaWNhdGlvbnMgY2FuIHNjaGVkdWxlIHRhc2tzIHRvIHJ1biBhZnRlciBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZm9sbG93aW5nOlxuICpcbiAqIGBgYFxuICogSW50ZXJhY3Rpb25NYW5hZ2VyLnJ1bkFmdGVySW50ZXJhY3Rpb25zKCgpID0+IHtcbiAqICAgLy8gLi4ubG9uZy1ydW5uaW5nIHN5bmNocm9ub3VzIHRhc2suLi5cbiAqIH0pO1xuICogYGBgXG4gKlxuICogQ29tcGFyZSB0aGlzIHRvIG90aGVyIHNjaGVkdWxpbmcgYWx0ZXJuYXRpdmVzOlxuICpcbiAqIC0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk6IGZvciBjb2RlIHRoYXQgYW5pbWF0ZXMgYSB2aWV3IG92ZXIgdGltZS5cbiAqIC0gc2V0SW1tZWRpYXRlL3NldFRpbWVvdXQoKTogcnVuIGNvZGUgbGF0ZXIsIG5vdGUgdGhpcyBtYXkgZGVsYXkgYW5pbWF0aW9ucy5cbiAqIC0gcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKTogcnVuIGNvZGUgbGF0ZXIsIHdpdGhvdXQgZGVsYXlpbmcgYWN0aXZlIGFuaW1hdGlvbnMuXG4gKlxuICogVGhlIHRvdWNoIGhhbmRsaW5nIHN5c3RlbSBjb25zaWRlcnMgb25lIG9yIG1vcmUgYWN0aXZlIHRvdWNoZXMgdG8gYmUgYW5cbiAqICdpbnRlcmFjdGlvbicgYW5kIHdpbGwgZGVsYXkgYHJ1bkFmdGVySW50ZXJhY3Rpb25zKClgIGNhbGxiYWNrcyB1bnRpbCBhbGxcbiAqIHRvdWNoZXMgaGF2ZSBlbmRlZCBvciBiZWVuIGNhbmNlbGxlZC5cbiAqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxzbyBhbGxvd3MgYXBwbGljYXRpb25zIHRvIHJlZ2lzdGVyIGFuaW1hdGlvbnMgYnlcbiAqIGNyZWF0aW5nIGFuIGludGVyYWN0aW9uICdoYW5kbGUnIG9uIGFuaW1hdGlvbiBzdGFydCwgYW5kIGNsZWFyaW5nIGl0IHVwb25cbiAqIGNvbXBsZXRpb246XG4gKlxuICogYGBgXG4gKiB2YXIgaGFuZGxlID0gSW50ZXJhY3Rpb25NYW5hZ2VyLmNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk7XG4gKiAvLyBydW4gYW5pbWF0aW9uLi4uIChgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgIHRhc2tzIGFyZSBxdWV1ZWQpXG4gKiAvLyBsYXRlciwgb24gYW5pbWF0aW9uIGNvbXBsZXRpb246XG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIuY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGUpO1xuICogLy8gcXVldWVkIHRhc2tzIHJ1biBpZiBhbGwgaGFuZGxlcyB3ZXJlIGNsZWFyZWRcbiAqIGBgYFxuICpcbiAqIGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFrZXMgZWl0aGVyIGEgcGxhaW4gY2FsbGJhY2sgZnVuY3Rpb24sIG9yIGFcbiAqIGBQcm9taXNlVGFza2Agb2JqZWN0IHdpdGggYSBgZ2VuYCBtZXRob2QgdGhhdCByZXR1cm5zIGEgYFByb21pc2VgLiAgSWYgYVxuICogYFByb21pc2VUYXNrYCBpcyBzdXBwbGllZCwgdGhlbiBpdCBpcyBmdWxseSByZXNvbHZlZCAoaW5jbHVkaW5nIGFzeW5jaHJvbm91c1xuICogZGVwZW5kZW5jaWVzIHRoYXQgYWxzbyBzY2hlZHVsZSBtb3JlIHRhc2tzIHZpYSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgKSBiZWZvcmVcbiAqIHN0YXJ0aW5nIG9uIHRoZSBuZXh0IHRhc2sgdGhhdCBtaWdodCBoYXZlIGJlZW4gcXVldWVkIHVwIHN5bmNocm9ub3VzbHlcbiAqIGVhcmxpZXIuXG4gKlxuICogQnkgZGVmYXVsdCwgcXVldWVkIHRhc2tzIGFyZSBleGVjdXRlZCB0b2dldGhlciBpbiBhIGxvb3AgaW4gb25lXG4gKiBgc2V0SW1tZWRpYXRlYCBiYXRjaC4gSWYgYHNldERlYWRsaW5lYCBpcyBjYWxsZWQgd2l0aCBhIHBvc2l0aXZlIG51bWJlciwgdGhlblxuICogdGFza3Mgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIHVudGlsIHRoZSBkZWFkbGluZSAoaW4gdGVybXMgb2YganMgZXZlbnQgbG9vcCBydW5cbiAqIHRpbWUpIGFwcHJvYWNoZXMsIGF0IHdoaWNoIHBvaW50IGV4ZWN1dGlvbiB3aWxsIHlpZWxkIHZpYSBzZXRUaW1lb3V0LFxuICogYWxsb3dpbmcgZXZlbnRzIHN1Y2ggYXMgdG91Y2hlcyB0byBzdGFydCBpbnRlcmFjdGlvbnMgYW5kIGJsb2NrIHF1ZXVlZCB0YXNrc1xuICogZnJvbSBleGVjdXRpbmcsIG1ha2luZyBhcHBzIG1vcmUgcmVzcG9uc2l2ZS5cbiAqL1xuY29uc3QgSW50ZXJhY3Rpb25NYW5hZ2VyID0ge1xuICBFdmVudHM6IHtcbiAgICBpbnRlcmFjdGlvblN0YXJ0OiAnaW50ZXJhY3Rpb25TdGFydCcsXG4gICAgaW50ZXJhY3Rpb25Db21wbGV0ZTogJ2ludGVyYWN0aW9uQ29tcGxldGUnLFxuICB9LFxuXG4gIC8qKlxuICAgKiBTY2hlZHVsZSBhIGZ1bmN0aW9uIHRvIHJ1biBhZnRlciBhbGwgaW50ZXJhY3Rpb25zIGhhdmUgY29tcGxldGVkLiBSZXR1cm5zIGEgY2FuY2VsbGFibGVcbiAgICogXCJwcm9taXNlXCIuXG4gICAqL1xuICBydW5BZnRlckludGVyYWN0aW9ucyh0YXNrOiA/VGFzayk6IHtcbiAgICB0aGVuOiA8VT4oXG4gICAgICBvbkZ1bGZpbGw/OiA/KHZvaWQpID0+ID8oUHJvbWlzZTxVPiB8IFUpLFxuICAgICAgb25SZWplY3Q/OiA/KGVycm9yOiBtaXhlZCkgPT4gPyhQcm9taXNlPFU+IHwgVSksXG4gICAgKSA9PiBQcm9taXNlPFU+LFxuICAgIGRvbmU6ICgpID0+IHZvaWQsXG4gICAgY2FuY2VsOiAoKSA9PiB2b2lkLFxuICAgIC4uLlxuICB9IHtcbiAgICBjb25zdCB0YXNrczogQXJyYXk8VGFzaz4gPSBbXTtcbiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmU6ICgpID0+IHZvaWQpID0+IHtcbiAgICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgICAgaWYgKHRhc2spIHtcbiAgICAgICAgdGFza3MucHVzaCh0YXNrKTtcbiAgICAgIH1cbiAgICAgIHRhc2tzLnB1c2goe1xuICAgICAgICBydW46IHJlc29sdmUsXG4gICAgICAgIG5hbWU6ICdyZXNvbHZlICcgKyAoKHRhc2sgJiYgdGFzay5uYW1lKSB8fCAnPycpLFxuICAgICAgfSk7XG4gICAgICBfdGFza1F1ZXVlLmVucXVldWVUYXNrcyh0YXNrcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIC8vICRGbG93Rml4TWVbbWV0aG9kLXVuYmluZGluZ10gYWRkZWQgd2hlbiBpbXByb3ZpbmcgdHlwaW5nIGZvciB0aGlzIHBhcmFtZXRlcnNcbiAgICAgIHRoZW46IHByb21pc2UudGhlbi5iaW5kKHByb21pc2UpLFxuICAgICAgZG9uZTogKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgLy8gJEZsb3dGaXhNZVttZXRob2QtdW5iaW5kaW5nXSBhZGRlZCB3aGVuIGltcHJvdmluZyB0eXBpbmcgZm9yIHRoaXMgcGFyYW1ldGVyc1xuICAgICAgICBpZiAocHJvbWlzZS5kb25lKSB7XG4gICAgICAgICAgcmV0dXJuIHByb21pc2UuZG9uZSguLi5hcmdzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAnVHJpZWQgdG8gY2FsbCBkb25lIHdoZW4gbm90IHN1cHBvcnRlZCBieSBjdXJyZW50IFByb21pc2UgaW1wbGVtZW50YXRpb24uJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIF90YXNrUXVldWUuY2FuY2VsVGFza3ModGFza3MpO1xuICAgICAgfSxcbiAgICB9O1xuICB9LFxuXG4gIC8qKlxuICAgKiBOb3RpZnkgbWFuYWdlciB0aGF0IGFuIGludGVyYWN0aW9uIGhhcyBzdGFydGVkLlxuICAgKi9cbiAgY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUoKTogSGFuZGxlIHtcbiAgICBERUJVRyAmJiBpbmZvTG9nKCdJbnRlcmFjdGlvbk1hbmFnZXI6IGNyZWF0ZSBpbnRlcmFjdGlvbiBoYW5kbGUnKTtcbiAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICBjb25zdCBoYW5kbGUgPSArK19pbmM7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpO1xuICAgIHJldHVybiBoYW5kbGU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIGNvbXBsZXRlZC5cbiAgICovXG4gIGNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlOiBIYW5kbGUpIHtcbiAgICBERUJVRyAmJiBpbmZvTG9nKCdJbnRlcmFjdGlvbk1hbmFnZXI6IGNsZWFyIGludGVyYWN0aW9uIGhhbmRsZScpO1xuICAgIGludmFyaWFudCghIWhhbmRsZSwgJ0ludGVyYWN0aW9uTWFuYWdlcjogTXVzdCBwcm92aWRlIGEgaGFuZGxlIHRvIGNsZWFyLicpO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIF9hZGRJbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKTtcbiAgICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7XG4gIH0sXG5cbiAgLy8gJEZsb3dGaXhNZVttZXRob2QtdW5iaW5kaW5nXSBhZGRlZCB3aGVuIGltcHJvdmluZyB0eXBpbmcgZm9yIHRoaXMgcGFyYW1ldGVyc1xuICBhZGRMaXN0ZW5lcjogKF9lbWl0dGVyLmFkZExpc3RlbmVyLmJpbmQoX2VtaXR0ZXIpOiAkRmxvd0ZpeE1lKSxcblxuICAvKipcbiAgICogQSBwb3NpdGl2ZSBudW1iZXIgd2lsbCB1c2Ugc2V0VGltZW91dCB0byBzY2hlZHVsZSBhbnkgdGFza3MgYWZ0ZXIgdGhlXG4gICAqIGV2ZW50TG9vcFJ1bm5pbmdUaW1lIGhpdHMgdGhlIGRlYWRsaW5lIHZhbHVlLCBvdGhlcndpc2UgYWxsIHRhc2tzIHdpbGwgYmVcbiAgICogZXhlY3V0ZWQgaW4gb25lIHNldEltbWVkaWF0ZSBiYXRjaCAoZGVmYXVsdCkuXG4gICAqL1xuICBzZXREZWFkbGluZShkZWFkbGluZTogbnVtYmVyKSB7XG4gICAgX2RlYWRsaW5lID0gZGVhZGxpbmU7XG4gIH0sXG59O1xuXG5jb25zdCBfaW50ZXJhY3Rpb25TZXQgPSBuZXcgU2V0KCk7XG5jb25zdCBfYWRkSW50ZXJhY3Rpb25TZXQgPSBuZXcgU2V0KCk7XG5jb25zdCBfZGVsZXRlSW50ZXJhY3Rpb25TZXQgPSBuZXcgU2V0KCk7XG5jb25zdCBfdGFza1F1ZXVlID0gbmV3IFRhc2tRdWV1ZSh7b25Nb3JlVGFza3M6IF9zY2hlZHVsZVVwZGF0ZX0pO1xubGV0IF9uZXh0VXBkYXRlSGFuZGxlID0gMDtcbmxldCBfaW5jID0gMDtcbmxldCBfZGVhZGxpbmUgPSAtMTtcblxuLyoqXG4gKiBTY2hlZHVsZSBhbiBhc3luY2hyb25vdXMgdXBkYXRlIHRvIHRoZSBpbnRlcmFjdGlvbiBzdGF0ZS5cbiAqL1xuZnVuY3Rpb24gX3NjaGVkdWxlVXBkYXRlKCkge1xuICBpZiAoIV9uZXh0VXBkYXRlSGFuZGxlKSB7XG4gICAgaWYgKF9kZWFkbGluZSA+IDApIHtcbiAgICAgIF9uZXh0VXBkYXRlSGFuZGxlID0gc2V0VGltZW91dChfcHJvY2Vzc1VwZGF0ZSwgMCArIERFQlVHX0RFTEFZKTtcbiAgICB9IGVsc2Uge1xuICAgICAgX25leHRVcGRhdGVIYW5kbGUgPSBzZXRJbW1lZGlhdGUoX3Byb2Nlc3NVcGRhdGUpO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIE5vdGlmeSBsaXN0ZW5lcnMsIHByb2Nlc3MgcXVldWUsIGV0Y1xuICovXG5mdW5jdGlvbiBfcHJvY2Vzc1VwZGF0ZSgpIHtcbiAgX25leHRVcGRhdGVIYW5kbGUgPSAwO1xuXG4gIGNvbnN0IGludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTtcbiAgX2FkZEludGVyYWN0aW9uU2V0LmZvckVhY2goaGFuZGxlID0+IF9pbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKSk7XG4gIF9kZWxldGVJbnRlcmFjdGlvblNldC5mb3JFYWNoKGhhbmRsZSA9PiBfaW50ZXJhY3Rpb25TZXQuZGVsZXRlKGhhbmRsZSkpO1xuICBjb25zdCBuZXh0SW50ZXJhY3Rpb25Db3VudCA9IF9pbnRlcmFjdGlvblNldC5zaXplO1xuXG4gIGlmIChpbnRlcmFjdGlvbkNvdW50ICE9PSAwICYmIG5leHRJbnRlcmFjdGlvbkNvdW50ID09PSAwKSB7XG4gICAgLy8gdHJhbnNpdGlvbiBmcm9tIDErIC0tPiAwIGludGVyYWN0aW9uc1xuICAgIF9lbWl0dGVyLmVtaXQoSW50ZXJhY3Rpb25NYW5hZ2VyLkV2ZW50cy5pbnRlcmFjdGlvbkNvbXBsZXRlKTtcbiAgfSBlbHNlIGlmIChpbnRlcmFjdGlvbkNvdW50ID09PSAwICYmIG5leHRJbnRlcmFjdGlvbkNvdW50ICE9PSAwKSB7XG4gICAgLy8gdHJhbnNpdGlvbiBmcm9tIDAgLS0+IDErIGludGVyYWN0aW9uc1xuICAgIF9lbWl0dGVyLmVtaXQoSW50ZXJhY3Rpb25NYW5hZ2VyLkV2ZW50cy5pbnRlcmFjdGlvblN0YXJ0KTtcbiAgfVxuXG4gIC8vIHByb2Nlc3MgdGhlIHF1ZXVlIHJlZ2FyZGxlc3Mgb2YgYSB0cmFuc2l0aW9uXG4gIGlmIChuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkge1xuICAgIHdoaWxlIChfdGFza1F1ZXVlLmhhc1Rhc2tzVG9Qcm9jZXNzKCkpIHtcbiAgICAgIF90YXNrUXVldWUucHJvY2Vzc05leHQoKTtcbiAgICAgIGlmIChcbiAgICAgICAgX2RlYWRsaW5lID4gMCAmJlxuICAgICAgICBCYXRjaGVkQnJpZGdlLmdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lKCkgPj0gX2RlYWRsaW5lXG4gICAgICApIHtcbiAgICAgICAgLy8gSGl0IGRlYWRsaW5lIGJlZm9yZSBwcm9jZXNzaW5nIGFsbCB0YXNrcywgc28gcHJvY2VzcyBtb3JlIGxhdGVyLlxuICAgICAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIF9hZGRJbnRlcmFjdGlvblNldC5jbGVhcigpO1xuICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBJbnRlcmFjdGlvbk1hbmFnZXI7XG4iXSwibWFwcGluZ3MiOiI7QUFnQkEsSUFBQUEsYUFBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBTkEsSUFBTUMsYUFBYSxHQUFHRCxPQUFPLENBQUMsZ0NBQWdDLENBQUM7QUFDL0QsSUFBTUUsU0FBUyxHQUFHRixPQUFPLENBQUMsYUFBYSxDQUFDO0FBRXhDLElBQU1HLE9BQU8sR0FBR0gsT0FBTyxDQUFDLHNCQUFzQixDQUFDO0FBQy9DLElBQU1JLFNBQVMsR0FBR0osT0FBTyxDQUFDLFdBQVcsQ0FBQztBQU90QyxJQUFNSyxRQUFRLEdBQUcsSUFBSUMscUJBQVksRUFHN0I7QUFFSixJQUFNQyxXQUFjLEdBQUcsQ0FBQztBQUN4QixJQUFNQyxLQUFZLEdBQUcsS0FBSztBQW1EMUIsSUFBTUMsa0JBQWtCLEdBQUc7RUFDekJDLE1BQU0sRUFBRTtJQUNOQyxnQkFBZ0IsRUFBRSxrQkFBa0I7SUFDcENDLG1CQUFtQixFQUFFO0VBQ3ZCLENBQUM7RUFNREMsb0JBQW9CLFdBQUFBLHFCQUFDQyxJQUFXLEVBUTlCO0lBQ0EsSUFBTUMsS0FBa0IsR0FBRyxFQUFFO0lBQzdCLElBQU1DLE9BQU8sR0FBRyxJQUFJQyxPQUFPLENBQUMsVUFBQ0MsT0FBbUIsRUFBSztNQUNuREMsZUFBZSxFQUFFO01BQ2pCLElBQUlMLElBQUksRUFBRTtRQUNSQyxLQUFLLENBQUNLLElBQUksQ0FBQ04sSUFBSSxDQUFDO01BQ2xCO01BQ0FDLEtBQUssQ0FBQ0ssSUFBSSxDQUFDO1FBQ1RDLEdBQUcsRUFBRUgsT0FBTztRQUNaSSxJQUFJLEVBQUUsVUFBVSxJQUFLUixJQUFJLElBQUlBLElBQUksQ0FBQ1Es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